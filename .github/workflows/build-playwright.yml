name: build-playwright

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git authentication for GitHub
        run: |
          git config --global url."https://x-access-token:${{ github.token }}@github.com/".insteadOf "https://github.com/"

      - name: Install build dependencies (ninja, git-lfs)
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build git-lfs

      - name: Initialize Git LFS
        run: git lfs install

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          cache: "npm"

      - name: Build with Emscripten
        run: |
          $GITHUB_WORKSPACE/ci/00_linux_setup.bash
          $GITHUB_WORKSPACE/ci/10_linux_build.bash

      - name: Install UI dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Set up  mapget
        run: |
          python3 -m venv venv
          ./venv/bin/pip install mapget

      - name: Run Playwright integration tests (with coverage)
        run: |
          source ./venv/bin/activate
          $GITHUB_WORKSPACE/ci/run-integration-with-venv-mapget.sh

      - name: Upload Playwright coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: playwright-coverage
          path: coverage/playwright

      - name: Comment PR with Playwright coverage summary
        # Skip forks where the GITHUB_TOKEN cannot write to issues/comments
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const summaryPath = path.join(
              process.env.GITHUB_WORKSPACE,
              'coverage',
              'playwright',
              'v8-coverage-summary.json'
            );

            if (!fs.existsSync(summaryPath)) {
              core.warning(`V8 coverage summary not found at ${summaryPath}`);
              return;
            }

            const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
            const format = (obj) =>
              `${obj.pct.toFixed(1)}% (${obj.usedBytes}/${obj.totalBytes} bytes)`;

            const marker = '<!-- playwright-v8-coverage-report -->';
            const body = [
              marker,
              '## Playwright (integration) V8 coverage',
              '',
              `- JS:       ${format(summary.js)}`,
              `- CSS:      ${format(summary.css)}`,
              `- Combined: ${format(summary.combined)}`,
              '',
              `Artifact: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            ].join('\n');

            try {
              const comments = await github.paginate(
                github.rest.issues.listComments,
                {
                  ...context.repo,
                  issue_number: context.issue.number,
                  per_page: 100
                }
              );

              const coverageComments = comments.filter((comment) => comment.body?.includes(marker));

              for (const comment of coverageComments) {
                await github.rest.issues.deleteComment({
                  ...context.repo,
                  comment_id: comment.id
                });
              }

              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body
              });
            } catch (error) {
              core.warning(`Skipping coverage comment (token likely lacks permission): ${error.message}`);
